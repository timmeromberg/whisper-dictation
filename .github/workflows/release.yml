name: Release

on:
  workflow_run:
    workflows: [E2E]
    types: [completed]
    branches: [main]

jobs:
  release:
    name: Create release and publish to PyPI
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' }}
    concurrency:
      group: release-${{ github.event.workflow_run.head_sha }}
      cancel-in-progress: false
    environment: pypi
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.12"

      - name: Verify CI and E2E success for this SHA
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHA="${{ github.event.workflow_run.head_sha }}"
          RUNS_JSON=$(gh api "repos/${{ github.repository }}/actions/runs?head_sha=$SHA&event=push&per_page=100")
          CI_CONCLUSION=$(echo "$RUNS_JSON" | jq -r '[.workflow_runs[] | select(.name=="CI") | .conclusion][0] // "missing"')
          E2E_CONCLUSION=$(echo "$RUNS_JSON" | jq -r '[.workflow_runs[] | select(.name=="E2E") | .conclusion][0] // "missing"')
          echo "CI conclusion: $CI_CONCLUSION"
          echo "E2E conclusion: $E2E_CONCLUSION"
          if [ "$CI_CONCLUSION" != "success" ] || [ "$E2E_CONCLUSION" != "success" ]; then
            echo "::error::Refusing release: CI and E2E must both be successful for $SHA"
            exit 1
          fi

      - name: Read version
        id: version
        run: echo "version=$(cat src/whisper_dic/VERSION | tr -d '[:space:]')" >> "$GITHUB_OUTPUT"

      - name: Check if tag exists
        id: check_tag
        run: |
          if git ls-remote --tags origin "v${{ steps.version.outputs.version }}" | grep -q .; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Extract changelog entry
        if: steps.check_tag.outputs.exists == 'false'
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Extract the section for this version from CHANGELOG.md
          BODY=$(awk "/^## \[$VERSION\]/{found=1; next} /^## \[/{if(found) exit} found{print}" CHANGELOG.md)
          if [ -z "$BODY" ]; then
            BODY="Release v$VERSION"
          fi
          # Write to file for gh release
          echo "$BODY" > /tmp/release-notes.md

      - name: Create GitHub release
        if: steps.check_tag.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ steps.version.outputs.version }}" \
            --title "v${{ steps.version.outputs.version }}" \
            --notes-file /tmp/release-notes.md \
            --target "${{ github.event.workflow_run.head_sha }}"

      - name: Build distribution
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          pip install build
          python -m build

      - name: Publish to PyPI
        if: steps.check_tag.outputs.exists == 'false'
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # release/v1
