name: E2E

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'scripts/e2e-test.sh'
      - 'Dockerfile.e2e'
      - '.github/workflows/e2e.yml'
  workflow_dispatch:

jobs:
  e2e-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - name: Cache whisper-dic data (model + binary)
        uses: actions/cache@v4
        with:
          path: /tmp/whisper-dic-cache
          key: e2e-linux-whisper-data-v1
      - name: Build and run E2E
        run: |
          docker compose build e2e
          docker compose run -v /tmp/whisper-dic-cache:/root/.local/share/whisper-dic e2e

  e2e-macos:
    runs-on: macos-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
      - name: Cache whisper-dic data (model + binary)
        uses: actions/cache@v4
        with:
          path: ~/.local/share/whisper-dic
          key: e2e-macos-whisper-data-v1
      - name: Install system deps
        run: brew install ffmpeg
      - name: Install
        run: |
          pip install -e ".[macos]"
      - name: Run E2E
        run: bash scripts/e2e-test.sh

  e2e-windows:
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
      - name: Cache whisper-dic data (model + binary)
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\whisper-dic
          key: e2e-windows-whisper-data-v1
      - name: Install
        run: pip install -e .
      - name: Install ffmpeg
        run: choco install ffmpeg -y
      - name: Run E2E
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bash scripts/e2e-test.sh
