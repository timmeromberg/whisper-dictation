name: E2E

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'scripts/e2e-test.sh'
      - 'scripts/e2e-pr-smoke.sh'
      - 'Dockerfile.e2e'
      - '.github/workflows/e2e.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  e2e-pr-smoke:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.12"
          cache: pip
      - name: Install
        run: pip install -e .
      - name: Run PR E2E Smoke
        run: bash scripts/e2e-pr-smoke.sh

  e2e-linux:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Cache whisper-dic data (model + binary)
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: /tmp/whisper-dic-cache
          key: e2e-linux-whisper-data-v1
      - name: Build and run E2E
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          docker compose build e2e
          docker compose run -e GITHUB_TOKEN="$GITHUB_TOKEN" -v /tmp/whisper-dic-cache:/root/.local/share/whisper-dic e2e

  e2e-macos:
    if: github.event_name != 'pull_request'
    runs-on: macos-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.12"
          cache: pip
      - name: Cache whisper-dic data (model + binary)
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.local/share/whisper-dic
          key: e2e-macos-whisper-data-v1
      - name: Install system deps
        run: brew install ffmpeg
      - name: Install
        run: |
          pip install -e ".[macos]"
      - name: Run E2E
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bash scripts/e2e-test.sh

  e2e-windows:
    if: github.event_name != 'pull_request'
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.12"
          cache: pip
      - name: Cache whisper-dic data (model + binary)
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~\AppData\Local\whisper-dic
          key: e2e-windows-whisper-data-v1
      - name: Install
        run: pip install -e .
      - name: Install ffmpeg
        run: choco install ffmpeg -y
      - name: Run E2E
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bash scripts/e2e-test.sh
